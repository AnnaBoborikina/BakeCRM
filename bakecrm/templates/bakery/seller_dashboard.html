<!-- templates/bakery/seller_dashboard.html -->
{% extends 'base.html' %}
{% block title %}–†–∞–±–æ—á–µ–µ –º–µ—Å—Ç–æ –ø—Ä–æ–¥–∞–≤—Ü–∞ ‚Äî BakeCRM{% endblock %}

{% block content %}
<div class="hero text-center">
    <h2>–†–∞–±–æ—á–µ–µ –º–µ—Å—Ç–æ –ø—Ä–æ–¥–∞–≤—Ü–∞</h2>
    <p class="text-muted">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä—ã –¥–ª—è –Ω–æ–≤–æ–≥–æ –∑–∞–∫–∞–∑–∞</p>
</div>

<div class="card shadow-sm border-0 mb-4">
    <div class="card-body">
        <!-- –ü–æ–∏—Å–∫ -->
        <div class="input-group mb-3">
            <span class="input-group-text">üîç</span>
            <input type="text" id="productSearch" class="form-control" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é...">
        </div>

        <!-- –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º–∞—è –ø–∞–Ω–µ–ª—å —Ç–æ–≤–∞—Ä–æ–≤ -->
        <div id="productScrollContainer" style="height: 400px; overflow-y: auto;">
            <div class="row g-3" id="productList">
                {% for product in products %}
                <div class="col-6 col-md-4 col-lg-3 product-item" data-name="{{ product.name|lower }}">
                    <div class="card h-100 border-0 shadow-sm" style="cursor: pointer;" 
                         onclick="addToOrder({{ product.id }}, '{{ product.name|escapejs }}', {{ product.price }})">
                        {% if product.image %}
                        <img src="{{ product.image.url }}" class="card-img-top" alt="{{ product.name }}" 
                             style="height: 120px; object-fit: cover; border-radius: 8px 8px 0 0;">
                        {% else %}
                        <div class="bg-light d-flex align-items-center justify-content-center" 
                             style="height: 120px; border-radius: 8px 8px 0 0;">
                            <span class="text-muted">–ù–µ—Ç —Ñ–æ—Ç–æ</span>
                        </div>
                        {% endif %}
                        <div class="card-body text-center p-2">
                            <h6 class="card-title mb-1">{{ product.name }}</h6>
                            <div class="h6 text-success">{{ product.price }} ‚ÇΩ</div>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="col-12 text-center text-muted">–ù–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤</div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- –ö–æ—Ä–∑–∏–Ω–∞ (–ø–æ–¥ –ø–∞–Ω–µ–ª—å—é —Ç–æ–≤–∞—Ä–æ–≤) -->
<div id="cartSection" class="card shadow-sm border-0" style="display: none;">
    <div class="card-header bg-light">
        <h5 class="mb-0">–í–∞—à –∑–∞–∫–∞–∑</h5>
    </div>
    <div class="card-body">
        <div id="cartItemsContainer">
            <!-- –°—é–¥–∞ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –ø–æ–∑–∏—Ü–∏–∏ -->
        </div>
        <hr>
        <div class="d-flex justify-content-between align-items-center">
            <strong>–ò—Ç–æ–≥–æ: <span id="orderTotal">0</span> ‚ÇΩ</strong>
            <button class="btn btn-success" onclick="showConfirmModal()">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ -->
<div class="modal fade" id="confirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑ –Ω–∞ —Å—É–º–º—É <strong id="confirmTotal">0 ‚ÇΩ</strong>?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-primary" onclick="showPaymentModal()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="paymentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–û–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑ —Ç–µ—Ä–º–∏–Ω–∞–ª</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <div class="display-6 mb-4">üí≥</div>
                <p>–ò–º–∏—Ç–∞—Ü–∏—è –æ–ø–ª–∞—Ç—ã —á–µ—Ä–µ–∑ –±–∞–Ω–∫–æ–≤—Å–∫–∏–π —Ç–µ—Ä–º–∏–Ω–∞–ª...</p>
                <div class="spinner-border text-primary" role="status" id="paymentSpinner" style="display: none;">
                    <span class="visually-hidden">–û–±—Ä–∞–±–æ—Ç–∫–∞...</span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-success" onclick="processPayment()">–û–ø–ª–∞—Ç–∏—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="successModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">‚úÖ –ó–∞–∫–∞–∑ –∑–∞–≤–µ—Ä—à—ë–Ω!</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <p class="lead">–ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω –∏ –æ–ø–ª–∞—á–µ–Ω!</p>
                <p><strong>–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞:</strong> <span id="successOrderId">#1</span></p>
                <p><strong>–°—É–º–º–∞:</strong> <span id="successTotal">0 ‚ÇΩ</span></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success" data-bs-dismiss="modal" onclick="resetCart()">–û–ö</button>
            </div>
        </div>
    </div>
</div>
<br><br><br><br><br><br>
{% endblock %}

{% block extra_js %}
<script>
let cart = [];

function addToOrder(productId, name, price) {
    const item = cart.find(i => i.id === productId);
    if (item) {
        item.quantity += 1;
    } else {
        cart.push({ id: productId, name: name, price: price, quantity: 1 });
    }
    renderCart();
}

function updateQuantity(productId, newQuantity) {
    if (newQuantity < 1) {
        removeFromCart(productId);
        return;
    }
    const item = cart.find(i => i.id === productId);
    if (item) {
        item.quantity = newQuantity;
        renderCart();
    }
}

function removeFromCart(productId) {
    cart = cart.filter(i => i.id !== productId);
    renderCart();
}

function renderCart() {
    const container = document.getElementById('cartItemsContainer');
    const totalEl = document.getElementById('orderTotal');
    const cartSection = document.getElementById('cartSection');
    
    if (cart.length === 0) {
        cartSection.style.display = 'none';
        return;
    }
    
    cartSection.style.display = 'block';
    container.innerHTML = '';
    let total = 0;
    
    cart.forEach(item => {
        const itemEl = document.createElement('div');
        itemEl.className = 'd-flex align-items-center mb-2 p-2 border rounded';
        itemEl.innerHTML = `
            <div class="flex-grow-1">
                <strong>${item.name}</strong><br>
                <small>${item.price} ‚ÇΩ √ó <input type="number" value="${item.quantity}" 
                    min="1" class="form-control form-control-sm d-inline w-auto" 
                    style="width: 70px;" 
                    onchange="updateQuantity(${item.id}, parseInt(this.value))">
                </small>
            </div>
            <div class="text-end">
                <div>${(item.price * item.quantity).toFixed(2)} ‚ÇΩ</div>
                <button class="btn btn-sm btn-outline-danger mt-1" onclick="removeFromCart(${item.id})">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
        `;
        container.appendChild(itemEl);
        total += item.price * item.quantity;
    });
    
    totalEl.textContent = total.toFixed(2);
    document.getElementById('confirmTotal').textContent = total.toFixed(2) + ' ‚ÇΩ';
}

// –ü–æ–∏—Å–∫
document.getElementById('productSearch').addEventListener('input', function() {
    const query = this.value.toLowerCase();
    document.querySelectorAll('.product-item').forEach(item => {
        item.style.display = item.dataset.name.includes(query) ? 'block' : 'none';
    });
});

// === –ú–æ–¥–∞–ª–∫–∏ –∏ –æ–ø–ª–∞—Ç–∞ ===
function showConfirmModal() {
    if (cart.length === 0) return;
    const modal = new bootstrap.Modal(document.getElementById('confirmModal'));
    modal.show();
}

function showPaymentModal() {
    bootstrap.Modal.getInstance(document.getElementById('confirmModal')).hide();
    const modal = new bootstrap.Modal(document.getElementById('paymentModal'));
    modal.show();
}

function processPayment() {
    document.getElementById('paymentSpinner').style.display = 'inline-block';
    setTimeout(() => {
        fetch('{% url "bakery:order_create_ajax" %}', {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}'},
            body: JSON.stringify({ items: cart })
        })
        .then(r => r.json())
        .then(data => {
            document.getElementById('paymentSpinner').style.display = 'none';
            if (data.success) {
                bootstrap.Modal.getInstance(document.getElementById('paymentModal')).hide();
                document.getElementById('successOrderId').textContent = `#${data.order_id}`;
                document.getElementById('successTotal').textContent = `${data.total_amount} ‚ÇΩ`;
                const successModal = new bootstrap.Modal(document.getElementById('successModal'));
                successModal.show();
            } else {
                alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑'));
            }
        })
        .catch(() => {
            document.getElementById('paymentSpinner').style.display = 'none';
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞');
        });
    }, 800);
}

function resetCart() {
    cart = [];
    renderCart();
    document.querySelectorAll('.modal').forEach(modal => {
        bootstrap.Modal.getInstance(modal)?.hide();
    });
}
</script>
{% endblock %}